alias: Loft Play
id: loft_play
description: >
  Close window blinds and set scenes while playing in the Loft.

mode: queued

triggers:
- trigger: state
  entity_id: input_boolean.loft_play
  to: null

actions:
- choose:
  # Play time in the Loft.
  - conditions:
    - condition: state
      entity_id: input_boolean.loft_play
      state: 'on'
    sequence:
    # Turn off the automations for the window blinds and lights so they stay
    # where we set them.
    - action: automation.turn_off
      target:
        entity_id:
        - automation.dining_room_windows
        - automation.kitchen_windows
        - automation.loft_occupancy
      data:
        stop_actions: true

    # If the dining room windows are closed, close the top of window blinds.
    - if:
      - condition: state
        entity_id: binary_sensor.dining_room_top_windows
        state: 'off'
      then:
      - action: scene.turn_on
        target:
          entity_id: scene.afternoon_sun
    # Close the top of the kitchen window blinds.
    - action: scene.turn_on
      target:
        entity_id: scene.kitchen_nighttime

    # Turn on the wall and ceiling lights, to get their current scene state;
    # wait a few seconds for it to take effect.
    - action: light.turn_on
      target:
        entity_id:
        - light.loft_balcony_left
        - light.loft_balcony_center
        - light.loft_balcony_right
        - light.loft_wall_left
        - light.loft_wall_center
        - light.loft_wall_right
        - light.loft_east_left
        - light.loft_east_right
        - light.loft_south_left
        - light.loft_south_right
    - delay:
        seconds: 3
    - action: scene.create
      data:
        scene_id: loft_play
        snapshot_entities:
        - light.loft_balcony_left
        - light.loft_balcony_center
        - light.loft_balcony_right
        - light.loft_wall_left
        - light.loft_wall_center
        - light.loft_wall_right
        - light.loft_east_left
        - light.loft_east_right
        - light.loft_south_left
        - light.loft_south_right

    # Now change the wall and ceiling lights scene.
    - action: scene.turn_on
      target:
        entity_id:
        - scene.loft_ceiling_play
        - scene.loft_wall_play

  # Play time over.
  - conditions:
    - condition: state
      entity_id: input_boolean.loft_play
      state: 'off'
    sequence:
    # Activate and then delete the saved lighting scene to restore the lights
    # to whatever they were before.
    - action: scene.turn_on
      target:
        entity_id: scene.loft_play
    - action: scene.delete
      target:
        entity_id: scene.loft_play

    # Trigger the automations for the blinds and lights to set their typical
    # state at this point in time, then re-enable the automations.
    - action: automation.trigger
      target:
        entity_id:
        - automation.dining_room_windows
        - automation.kitchen_windows
        - automation.loft_occupancy
      data:
        skip_condition: true
    - action: automation.turn_on
      target:
        entity_id:
        - automation.dining_room_windows
        - automation.kitchen_windows
        - automation.loft_occupancy
